<template>
	<section class="login">
		<section class="beauty">
			<img src="https://images.unsplash.com/photo-1456428746267-a1756408f782?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80" />
		</section>

		<section class="authentication">
			<section>
				<svg width="120px" height="120px" viewBox="0 0 120 120" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
					<g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
						<g id="scatter_letsgo" transform="translate(-450.000000, -217.000000)" fill="#0799FF">
							<g id="Group-2" transform="translate(450.000000, 217.000000)">
								<path d="M60,0 C93.137085,0 120,26.862915 120,60 C120,93.137085 93.137085,120 60,120 C26.862915,120 0,93.137085 0,60 C0,26.862915 26.862915,0 60,0 Z M66.4051573,24.5454545 C64.1105655,24.5454545 61.8242028,24.8939558 59.5460009,25.5909687 C57.2677989,26.2879816 55.0797745,27.248296 52.9818619,28.4719409 C50.8839493,29.6955858 48.9335754,31.1360575 47.1306818,32.7933993 C45.3277882,34.450741 43.7625722,36.2319695 42.4349869,38.1371381 C41.1074016,40.0423067 40.0666559,42.0481248 39.3127185,44.1546527 C38.5587812,46.2611806 38.1818182,48.3521879 38.1818182,50.4277374 C38.1818182,52.8440488 38.5341967,54.9892674 39.2389642,56.8634576 C39.9437317,58.7376479 40.8697495,60.4181982 42.0170455,61.9051591 C43.1643414,63.3921199 44.4755171,64.7086801 45.9506119,65.8548791 C47.4257067,67.0010781 48.9335587,68.0698151 50.4742133,69.0611224 C52.0148678,70.0524296 53.5227199,71.0049996 54.9978147,71.918861 C56.4729095,72.8327223 57.7840852,73.7698034 58.9313811,74.7301323 C60.0786771,75.6904611 61.0046949,76.7282203 61.7094624,77.843441 C62.4142299,78.9586616 62.7666084,80.2287549 62.7666084,81.6537591 C62.7666084,83.6983303 62.1110205,85.3169248 60.7998252,86.5095913 C59.4886298,87.7022578 57.8004911,88.2985822 55.7353584,88.2985822 C54.7847418,88.2985822 53.9570621,88.1901595 53.2522946,87.9733111 C52.5475271,87.7564626 51.957498,87.516384 51.4821897,87.253068 C51.0068814,86.989752 50.6381132,86.7341845 50.3758741,86.4863577 L50.3758741,86.4863577 L49.8841783,86.0216847 C49.5891594,85.4640744 49.2121964,85.1852734 48.753278,85.1852734 C48.3926992,85.1852734 47.9829568,85.3711408 47.5240385,85.742881 C47.0651201,86.1146212 46.638988,86.571545 46.2456294,87.1136662 C45.8522708,87.6557873 45.5244768,88.2443671 45.2622378,88.8794233 C44.9999987,89.5144795 44.8688811,90.1108038 44.8688811,90.6684142 C44.8688811,90.8233059 45.0327781,91.1563182 45.3605769,91.667461 C45.6883758,92.1786038 46.2620151,92.7129723 47.0815122,93.2705826 C47.9010093,93.8281929 49.0155087,94.3315836 50.4250437,94.7807697 C51.8345787,95.2299558 53.6046659,95.4545455 55.7353584,95.4545455 C57.833271,95.4545455 59.8000345,95.0828108 61.635708,94.3393304 C63.4713816,93.59585 65.0611821,92.5890687 66.4051573,91.3189563 C67.7491326,90.0488439 68.806268,88.5541609 69.5765953,86.8348624 C70.3469226,85.1155639 70.7320804,83.2956131 70.7320804,81.3749553 C70.7320804,79.3923409 70.379702,77.6343458 69.6749344,76.1009174 C68.9701669,74.5674891 68.0359542,73.1734842 66.8722684,71.918861 C65.7085825,70.6642377 64.3892119,69.5180559 62.9141171,68.4802812 C61.4390223,67.4425064 59.9311703,66.4357251 58.3905157,65.4599071 C56.8498612,64.484089 55.3420091,63.5005411 53.8669143,62.5092339 C52.3918195,61.5179267 51.072449,60.4337006 49.9087631,59.2565233 C48.7450772,58.079346 47.8108645,56.7705303 47.106097,55.3300369 C46.4013295,53.8895436 46.048951,52.2554601 46.048951,50.4277374 C46.048951,48.6929497 46.3685501,47.0278884 47.0077579,45.4325033 C47.6469656,43.8371182 48.491035,42.3501797 49.5399913,40.971643 C50.5889476,39.5931064 51.8017851,38.3307575 53.1785402,37.1845586 C54.5552953,36.0383596 55.9811989,35.0625562 57.4562937,34.257119 C58.9313885,33.4516819 60.3982663,32.8243797 61.8569712,32.3751936 C63.315676,31.9260075 64.6678259,31.7014178 65.9134615,31.7014178 C67.9130345,31.7014178 69.3307432,32.1660861 70.1666302,33.0954367 C71.0025173,34.0247872 71.4204545,35.2948805 71.4204545,36.9057548 C71.4204545,38.4856507 70.9205688,40.1119897 69.9207823,41.7848207 C68.9209959,43.4576516 67.6835738,44.991057 66.208479,46.3850828 C64.7333842,47.7791086 63.1599734,48.9252904 61.4881993,49.8236626 C59.8164252,50.7220348 58.2921835,51.1712141 56.9154283,51.1712141 C56.4892898,51.1712141 56.1123268,51.1324917 55.784528,51.0550459 C55.4567291,50.9776 55.1862991,50.9311332 54.9732299,50.915644 C54.7601606,50.9001548 54.5962637,50.9543661 54.4815341,51.0782795 C54.3668045,51.2021929 54.3094406,51.465505 54.3094406,51.8682235 C54.3094406,52.3638771 54.4405581,52.9292236 54.7027972,53.5642798 C54.9650363,54.199336 55.3338044,54.8034047 55.8091128,55.3765042 C56.2844211,55.9496037 56.8744501,56.429761 57.5792177,56.8169903 C58.2839852,57.2042197 59.0788854,57.3978315 59.9639423,57.3978315 C60.9801187,57.3978315 62.1601768,57.1345195 63.5041521,56.6078875 C64.8481273,56.0812556 66.2330567,55.3455308 67.6589816,54.4006911 C69.0849066,53.4558513 70.4780308,52.3406474 71.838396,51.0550459 C73.1987612,49.7694443 74.4197935,48.3676949 75.5015297,46.8497557 C76.5832659,45.3318165 77.4519198,43.7209665 78.1075175,42.0171572 C78.7631152,40.3133478 79.0909091,38.5785862 79.0909091,36.8128202 C79.0909091,34.9541191 78.7958946,33.2735688 78.2058566,31.7711188 C77.6158187,30.2686688 76.7799442,28.9830865 75.698208,27.9143334 C74.6164719,26.8455803 73.2889065,26.0169218 71.715472,25.4283331 C70.1420376,24.8397445 68.3719504,24.5454545 66.4051573,24.5454545 Z" id="Combined-Shape"></path>
							</g>
						</g>
					</g>
				</svg>

				<section class="app-title">
					Scatter
				</section>

				<section class="inputs" v-if="ready && !working">
					<section v-if="isNewScatter">
						<Button class="big" primary="1" text="Create new Scatter" @click.native="login" />
						<section class="login-with">
							<span class="label">You can also load a</span><span class="option" @click="loadBackup">full backup file</span>&nbsp;<span class="label">that you have saved.</span>
						</section>
					</section>

					<section v-else>
						<Input v-on:enter="login" :text="password" v-on:changed="x => password = x" v-if="asWallet" type="password" placeholder="Enter your password" />
						<!--<Input v-on:enter="login" v-if="asWallet" type="password" placeholder="Confirm password" />-->
						<Button class="big" primary="1" text="Login" @click.native="login" />

						<section class="login-with">
							<span class="label">You can also</span> <span class="option" @click="reset">reset your account</span>&nbsp;<span class="label">to start over</span>
						</section>


						<!--<section class="login-with">-->
							<!--<span class="label">Or try it out with a</span>-->
							<!--<span class="option" @click="loginTest"><u>demo account</u></span>-->
						<!--</section>-->
					</section>
				</section>

				<section v-else class="loading">
					<i class="animate-spin fas fa-spinner"></i>
				</section>
			</section>
		</section>

	</section>
</template>

<script>
	import {mapState, mapActions} from 'vuex';
	import GoogleAuth from "../oauth/Google";
	import PopupService from "../services/utility/PopupService";
	import Popups from "../util/Popups";
	import BridgeWallet from "../services/BridgeWallet";
	import API, {GET, POST} from "../util/API";
	import KYCService from "../services/kyc/KYCService";
	import Loader from "../util/Loader";
	import SingletonService from "../services/utility/SingletonService";
	import {RouteNames} from "../vue/Routing";
	import * as Actions from "@walletpack/core/store/constants";
	import * as UIActions from "../store/ui_actions";
	import {getFileLocation} from "../services/wallets/FileService";
	import Scatter from '@walletpack/core/models/Scatter'
	import Keypair from '@walletpack/core/models/Keypair'
	import KeyPairService from '@walletpack/core/services/secure/KeyPairService'
	import AccountService from '@walletpack/core/services/blockchain/AccountService'

	let gauth;

	export default {
		data(){return {
			working:false,
			ready:false,
			asWallet:false,
			isNewScatter:false,
			password:'',
			restoringBackup:false,
		}},
		mounted(){
			typeof window.wallet === 'undefined' ? this.initAsBridge() : this.initAsWallet();

		},
		methods:{
			async initAsWallet(){
				this.asWallet = true;
				this.ready = true;
				this.isNewScatter = !(await window.wallet.exists());
			},
			async initAsBridge(){
				gauth = new GoogleAuth();
				if(!gauth) return this.ready = true;
				await gauth.init();
				this.ready = true;
			},
			loginSuccess(){
				Loader.set(true);
				this.$router.push({name:this.RouteNames.Dashboard})
			},
			async login(){
				if(this.working) return;
				this.working = true;

				if(this.asWallet) this.walletLogin();
				else this.oauthLogin();

			},
			async walletLogin(){
				if(!this.isNewScatter){
					if(await window.wallet.unlock(this.password)) {
						await this[Actions.LOAD_SCATTER]();
						this.loginSuccess();
					} else {
						PopupService.push(Popups.snackbar('Bad Password'));
						this.working = false;
					}
				} else {
					PopupService.push(Popups.showTerms(async accepted => {
						if(!accepted) return this.working = false;
						PopupService.push(Popups.getPassword(async password => {
							if(!password) return this.working = false;
							await this[UIActions.CREATE_SCATTER](password);
							this.loginSuccess();
						}, true))
					}))

				}


			},
			async oauthLogin(){
				const authCode = await gauth.getAuthCode().catch(() => null);
				if(!authCode) return this.working = false;

				const apiResult = await POST('oauth/google', {access_token:authCode})
				if(!apiResult) return this.working = false;

				const {isNew, session, requires2fa, email, kycHash} = apiResult;
				API.setSessionToken(session);

				const password = await new Promise(resolve => {
					PopupService.push(Popups.getPassword(password => {
						resolve(password);
					}, isNew))
				});

				if(!password) return this.working = false;

				const twoFactor = requires2fa ? await new Promise(resolve => {
					PopupService.push(Popups.twoFactorAuth(done => {
						if(!done && isNew) GET('2fa/cancel');
						resolve(done);
					}, isNew))
				}) : true;

				if(!twoFactor) return this.working = false;

				const encryptionKey = await GET('encryption_key').catch(() => null);
				if(!encryptionKey) return this.working = false;


				let loggedIn = false;
				if(isNew){
					const serverSideEntropy = await GET('entropy').catch(() => null);
					if(!serverSideEntropy) return this.working = false;
					loggedIn = await BridgeWallet.register(serverSideEntropy, password+encryptionKey, email)
				}
				else loggedIn = await BridgeWallet.login(password+encryptionKey);
				if(!loggedIn) return this.working = false;

				// If the user has gone through KYC, then we're setting their hash here
				// This should be done each time, just in case we have to revoke premium access.
				KYCService.setKycHash(kycHash);

				this.loginSuccess();
			},

			async loadBackup(){
				const unrestore = () => {
					this.working = false;
					this.restoringBackup = false;
					window.wallet.lock();
				}

				if(this.restoringBackup) return;
				this.restoringBackup = true;

				// TODO: fix for bridge
				const possibleFile = await getFileLocation(['json', 'txt']);
				if(!possibleFile) return unrestore();
				const file = possibleFile[0];
				if(!file) return unrestore();



				const importDesktopBackup = async (data, password) => {
					const [obj, salt] = data.split('|SLT|');
					if(!obj || !salt) {
						unrestore();
						return PopupService.push(Popups.snackbar('Error parsing backup'));
					}

					await window.wallet.lock();
					await window.wallet.unlock(password, true, salt);
					const decrypted = await window.wallet.decrypt(obj);
					if(typeof decrypted === 'object' && decrypted.hasOwnProperty('keychain')){
						decrypted.keychain = await window.wallet.decrypt(decrypted.keychain);
						decrypted.settings.backupLocation = '';
						this.working = false;
						PopupService.push(Popups.showTerms(async accepted => {
							if(!accepted) {
								window.wallet.lock();
								return;
							}
							decrypted.onboarded = true;
							await this[Actions.SET_SCATTER](Scatter.fromJson(decrypted));
							await window.wallet.lock();
							window.wallet.utility.reload();
						}))
					} else {
						unrestore();
						return PopupService.push(Popups.snackbar("Error decrypting backup"));
					}
				};

				const importExtensionBackup = async (data, password) => {
					const [obj, salt] = data.split('|SSLT|');

					if(!obj || !salt) {
						unrestore();
						return PopupService.push(Popups.snackbar("Error parsing backup"));
					}

					await window.wallet.lock();
					await window.wallet.unlock(password, true, salt);
					const decrypted = await window.wallet.decrypt(obj);
					if(typeof decrypted === 'object' && decrypted.hasOwnProperty('keychain')){
						const keypairs = await Promise.all(decrypted.keychain.keypairs
							.map(async x => {
								x.privateKey = await window.wallet.decrypt(x.privateKey)
								return x;
							})
							.map(async x => {
								const keypair = Keypair.fromJson({
									name:x.name,
									blockchains:[x.blockchain],
									privateKey:Crypto.privateKeyToBuffer(x.privateKey, x.blockchain),
								});
								await KeyPairService.makePublicKeys(keypair);
								return keypair;
							}));
						const scatter = await Scatter.create();
						scatter.keychain.keypairs = keypairs;


						this.working = false;
						PopupService.push(Popups.showTerms(async accepted => {
							if(!accepted) {
								window.wallet.lock();
								return;
							}
							scatter.onboarded = true;
							await this[Actions.SET_SCATTER](scatter);
							await Promise.all(keypairs.map(keypair => {
								return AccountService.importAllAccounts(keypair);
							}));
							await window.wallet.lock();
							window.wallet.utility.reload()
						}))
					} else {
						unrestore();
						return PopupService.push(Popups.snackbar("Error decrypting backup"));
					}
				};

				// TODO: Fix for bridge
				window.wallet.storage.openFile(file).then(data => {
					if(!data) {
						unrestore();
						return PopupService.push(Popups.snackbar("Can't read backup"));
					}

					const fileExtension = file.split('.')[file.split('.').length-1];
					PopupService.push(Popups.getPassword(async password => {
						if(!password || !password.length) return unrestore();
						this.working = true;
						try {
							switch(fileExtension){
								case 'json': return await importDesktopBackup(data, password);
								case 'txt': return await importExtensionBackup(data, password);
							}
						} catch(e){
							console.error('e',e);
							unrestore();
							return PopupService.push(Popups.snackbar("Error decrypting backup"));
						}
					}))
				})
			},
			reset(){

				PopupService.push(Popups.resetScatter())
			},
			...mapActions([
				Actions.LOAD_SCATTER,
				Actions.SET_SCATTER,
				UIActions.CREATE_SCATTER
			])
		},
		watch:{
			['window.wallet'](){
				this.initAsWallet();
			}
		}
	}
</script>

<style scoped lang="scss">
	@import "../styles/variables";

	.login {
		height:100vh;
		width:100vw;
		display:flex;
		overflow: hidden;
		align-items: center;
		justify-content: center;

		.authentication {
			background:rgba(255,255,255,1);
			padding:80px 120px;
			margin:0 auto;
			text-align:center;
			border-radius:4px;
			display:flex;
			justify-content: center;
			align-items:center;
			transition: all 1s ease-in-out;
			transition-property: opacity;
			width: 100%;
			height: 100%;

			.app-title {
				font-size:$font-size-large;
				font-weight:bold;
				margin:1rem 0 0 0;
			}

			.inputs {
				width:100%;
				margin-top:1rem;
				display:inline-block;
				font-size: $font-size-medium;
			}

			.loading {
				height:162px;
				display:flex;
				align-items: center;
				justify-content: center;
				font-size: 48px;
				color:$grey;
			}

			.logo {
				color:$blue;
				font-size: 80px;
				margin-bottom:20px;
			}

			.title {
				color:$black;
				margin-top:2px;
				font-size: $font-size-large;
				font-weight: bold;
			}

			.text {
				font-size: $font-size-medium;
				font-weight: bold;
				color:$grey;
			}

			button {
				width:100%;
				margin-bottom:10px;

				&.big {
					height:60px;
					font-size: $font-size-medium;
				}
			}

			.login-with {
				margin-top:20px;
				font-size: $font-size-tiny;

				.label {
					font-weight: bold;
					color:$grey;
				}

				.option {
					cursor: pointer;
					font-weight: bold;
					margin-left:4px;
					color:$blue;
					text-decoration: underline;
				}
			}
		}

		.beauty {
			position:fixed;
			top:0;
			bottom:0;
			left:0;
			right:0;
			z-index:-1;
			height:100vh;
			flex:1;
			background: #00a8ff;

			img {
				width:100%;
				height:100%;
				object-fit: cover;
				opacity: 0;
			}
		}

	}

	.mobile {
		.login {
			.authentication {
				padding:50px;
				width:calc(100% - 50px);
			}
		}
	}

	.blue-steel {
		.login {
			.authentication {
				background:$dark;

				.title {
					color:#fff;
				}
			}

			.beauty {
				&:after {
					content:'';
					display:block;
					position: absolute;
					top:0;
					bottom:0;
					left:0;
					right:0;
					background:rgba($dark, 0.5);
				}
			}

		}
	}

</style>

